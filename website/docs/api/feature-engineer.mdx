---
id: feature-engineer
title: Traitement des Features
hide_title: true
sidebar_label: Features
---

<!-- Complet for v1.0.0 release -->

import { FontAwesomeIcon } from '@fortawesome/react-fontawesome'
import { faWandSparkles, faFileCode, faObjectGroup, faBook, faArrowRight, faCogs, faCubes } from '@fortawesome/free-solid-svg-icons'
import Admonition from '@theme/Admonition';

## <FontAwesomeIcon icon={faCubes} /> `peak_detector.py` & `feature_engineer.py`

Cette √©tape est le c≈ìur de l'approche "physique" du pipeline. Elle est g√©r√©e par deux modules qui travaillent en tandem : [`PeakDetector`](https://github.com/PhD-Brown/AstroSpectro/blob/main/src/pipeline/peak_detector.py) et [`FeatureEngineer`](https://github.com/PhD-Brown/AstroSpectro/blob/main/src/pipeline/feature_engineering.py). Leur r√¥le combin√© est de transformer un spectre normalis√© en un vecteur de *features* num√©riques.

### <FontAwesomeIcon icon={faCogs} /> Workflow du Traitement

<div style={{textAlign: 'center', backgroundColor: 'var(--ifm-background-color-secondary)', padding: '1rem', borderRadius: 'var(--ifm-card-border-radius)'}}>

```mermaid
graph LR
    A["Spectre Normalis√©"] --> B(D√©tection des Pics<br><i>PeakDetector</i>);
    B --> C(Matching Raies Cibles<br><i>PeakDetector</i>);
    C --> D{"Raies Associ√©es<br><i>(wl, prominence)"</i>};
    D --> E(Calcul M√©triques<br><i>FeatureEngineer</i>);
    E --> F("Calcul Ratios<br><i>FeatureEngineer"</i>);
    F --> G["Vecteur de Features<br><i>(prom, fwhm, ratios...)"</i>];
```
</div>

1.  **`PeakDetector`** : Identifie les raies d'absorption.
2.  **`FeatureEngineer`** : Convertit ces d√©tections en un vecteur num√©rique.

## <FontAwesomeIcon icon={faObjectGroup} /> Classe `PeakDetector`

Cette classe recherche les minima locaux significatifs dans un spectre et les associe √† des raies spectrales connues.

<details>
<summary>D√©tails des attributs et de la configuration</summary>
<div>
<p>Le <code>PeakDetector</code> est initialis√© avec des param√®tres qui contr√¥lent sa sensibilit√©. Ces valeurs ont √©t√© optimis√©es par analyse visuelle interactive.</p>
<ul>
<li><strong><code>prominence</code></strong> : Seuil de profondeur minimale pour qu'un pic soit consid√©r√© comme significatif. C'est le param√®tre le plus important pour filtrer le bruit. Et est h√©rit√© de <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.find_peaks.html" target="_blank">scipy.signal.find_peaks</a>.</li>
<li><strong><code>window</code></strong> : Fen√™tre de tol√©rance (en √Öngstr√∂m) autour d'une raie th√©orique pour le matching.</li>
<li><strong><code>target_lines</code></strong> : Un dictionnaire des 6 raies astrophysiques que nous cherchons : <strong>HŒ±, HŒ≤, CaII K, CaII H, Mg_b, et Na_D</strong>.</li>
</ul>
</div>
</details>

### M√©thodes Principales

#### `analyze_spectrum(wavelength, flux)`
-   **R√¥le :** Orchestre le processus complet en appelant d'abord ``detect_peaks`` puis ``match_known_lines``.
-   **Retourne :** Un dictionnaire associant chaque nom de raie cible √† un tuple ``(longueur_d_onde, prominence)`` si un pic a √©t√© trouv√©, ou ``None`` sinon. C'est la sortie principale de ce module.

## <FontAwesomeIcon icon={faObjectGroup} /> Classe `FeatureEngineer`

Cette classe prend le dictionnaire de raies du ``PeakDetector`` et le transforme en un vecteur de *features riche* et pr√™t pour le Machine Learning.

### M√©thodes Principales

#### `extract_features(matched_lines, wavelength, flux_norm)`
-   **R√¥le :** Convertit les d√©tections en un vecteur num√©rique multi-dimensionnel.
-   **Logique :** Pour chaque raie cible, elle calcule plusieurs m√©triques physiques :
    1. **Prominence (Force) :** La profondeur de la raie, directement issue du PeakDetector.
    2. **Largeur (FWHM) :** La "Largeur √† Mi-Hauteur", calcul√©e avec ``specutils`` sur une version liss√©e (Savitzky-Golay) de la raie.
    3. **(Exp√©rimental) Skewness :** L'asym√©trie de la raie. (Actuellement retir√© car non informatif).
-   **Ratios :** Elle calcule ensuite des ratios entre les prominences de diff√©rentes raies (ex: CaII K / HŒ≤) pour cr√©er des features de temp√©rature.
-   **Retourne :** Une liste de features num√©riques (plus de 15 *features* au total).

## <FontAwesomeIcon icon={faBook} /> Exemples & Bonnes Pratiques

Ce snippet montre comment les deux classes travaillent ensemble.

```python title="Python title="Workflow pour un spectre"
# ... √† l'int√©rieur de la boucle du ProcessingPipeline ...

# 1. D√©tection et matching des raies
matched_lines = peak_detector.analyze_spectrum(wavelength, flux_norm)

# 2. Vectorisation et enrichissement
features_vector = feature_engineer.extract_features(matched_lines, wavelength, flux_norm)
# R√©sultat : un vecteur de 15+ features [prom_HŒ±, fwhm_HŒ±, prom_HŒ≤, ..., ratio_CaK_Hb, ...]
```

<div className="container" style={{padding: '0', marginTop: '2rem'}}>
<div className="row">
<div className="col col--6">
<Admonition type="tip" title="Bonnes Pratiques" icon="üí°">
<ul>
<li><strong>Normalisation d'abord :</strong> Toujours appliquer le pr√©traitement et la normalisation <em>avant</em> de d√©tecter les pics.</li>
<li><strong>Tuning des Param√®tres :</strong> Les valeurs de <code>prominence</code> et <code>window</code> ont un impact majeur. Elles ont √©t√© optimis√©es gr√¢ce √† l'outil de visualisation interactif.</li>
</ul>
</Admonition>
</div>
<div className="col col--6">
<Admonition type="danger" title="Cas Limites & Erreurs" icon="‚ò¢Ô∏è">
<ul>
<li>Si une raie n'est pas trouv√©e, ses <em>features</em> associ√©es (prominence, FWHM) sont mises √† <strong>z√©ro</strong>.</li>
<li>Les calculs de FWHM peuvent √©chouer sur des spectres tr√®s bruit√©s. Ces cas sont g√©r√©s et les <em>features</em> sont √©galement mises √† z√©ro.</li>
</ul>
</Admonition>
</div>
</div>
</div>
<div className="card">
<div className="card__header" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
<FontAwesomeIcon icon={faArrowRight} />
<h3>Prochaine √âtape du Pipeline</h3>
</div>
<div className="card__body">
<p>Une fois le vecteur de features obtenu, il est pr√™t √† √™tre utilis√© pour entra√Æner un mod√®le.</p>
</div>
<div className="card__footer">
<a href="./classifier" className="button button--primary button--block">
‚Üí Voir le Module Classifier
</a>
</div>
</div>