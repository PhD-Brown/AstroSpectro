---
id: preprocessor
title: Explication du pr√©traitement
hide_title: true
sidebar_label: Pr√©traitement
---

<!-- Complet for v0.1.0-alpha release -->

import { FontAwesomeIcon } from '@fortawesome/react-fontawesome'
import { faTools, faArrowRight, faFileCode, faObjectGroup, faExclamationTriangle, faLightbulb, faBook, faProjectDiagram } from '@fortawesome/free-solid-svg-icons'
import Admonition from '@theme/Admonition';

## <FontAwesomeIcon icon={faTools} /> `preprocessor.py`

> Ce module contient la classe `SpectraPreprocessor`, responsable du chargement et du nettoyage initial des spectres bruts. C'est la toute premi√®re √©tape de traitement actif du pipeline.

## <FontAwesomeIcon icon={faProjectDiagram} /> Workflow du Pr√©traitement

<div style={{textAlign: 'center', backgroundColor: 'var(--ifm-background-color-secondary)', padding: '1rem', borderRadius: 'var(--ifm-card-border-radius)'}}>

```mermaid
graph TD
    A["Fichier FITS brut (.gz)"] --> B(load_spectrum);
    B --> C{"Spectre (longueur d'onde, flux)"};
    C --> D(normalize_spectrum);
    D --> E[Spectre normalis√©<br><i>Pr√™t pour l'extraction de features</i>];
```

</div>

## <FontAwesomeIcon icon={faObjectGroup} /> Classe SpectraPreprocessor

> Encapsule la logique pour lire un fichier FITS de LAMOST DR5 et appliquer un pr√©traitement simple.

### Instanciation

La classe ne prend aucun argument √† l'initialisation.

```python title="Comment l'utiliser"
from src.pipeline.preprocessor import SpectraPreprocessor

# Cr√©e une instance du preprocessor
preprocessor = SpectraPreprocessor()
```

## M√©thodes Publiques :


### ``load_spectrum(hdul)``

> Cette m√©thode est le c≈ìur du chargement des donn√©es. Elle est sp√©cifiquement con√ßue pour le format de donn√©es de LAMOST DR5.

<details>
<summary>Cliquez pour voir les d√©tails de la m√©thode</summary>
- **Description :** Extrait le spectre (longueur d'onde, flux) √† partir d'un objet ``HDUList`` (provenant de ``astropy.io.fits``).
- **Arguments :**
  - ``hdul (astropy.io.fits.HDUList)`` : L'objet FITS ouvert contenant les donn√©es du spectre.
- **Retourne :**
  - tuple ``(np.ndarray, np.ndarray)`` : Un tuple contenant deux tableaux NumPy : ``(wavelength, flux)``.
- <FontAwesomeIcon icon={faExclamationTriangle} /> Erreurs Possibles :
  - ``ValueError`` : Lev√©e si les mots-cl√©s ``COEFF0`` ou ``COEFF1`` sont absents de l'en-t√™te FITS, rendant la reconstruction de l'axe des longueurs d'onde impossible.
- <FontAwesomeIcon icon={faLightbulb} /> Contexte Scientifique :
  - Cette m√©thode est sp√©cifiquement adapt√©e au format des donn√©es LAMOST DR5, o√π l'axe des longueurs d'onde est d√©fini par une √©chelle log-lin√©aire. Elle ne fonctionnera pas "telle quelle" pour des relev√©s comme SDSS qui utilisent une structure de header diff√©rente.
- Logique :
  1. Extrait le vecteur de flux depuis la premi√®re extension de donn√©es ``(hdul[0].data[0])``.
  2. Reconstruit le vecteur des longueurs d'onde en Angstr√∂ms en utilisant les coefficients ``COEFF0`` et ``COEFF1`` de l'en-t√™te FITS.
</details>

<br/>

### ``normalize_spectrum(flux)``

> Applique une normalisation simple pour ramener les spectres √† une √©chelle comparable.

<details>
<summary>Cliquez pour voir les d√©tails de la m√©thode</summary>
- **Description :** Normalise un vecteur de flux en le divisant par sa valeur m√©diane.
- **Arguments :**
  - ``flux (np.ndarray)`` : Le vecteur de flux du spectre.
- **Retourne :**
  - ``np.ndarray`` : Le vecteur de flux normalis√©.
- <FontAwesomeIcon icon={faExclamationTriangle} /> Erreurs Possibles :
  - Aucune erreur n'est lev√©e directement. Si la m√©diane du flux est nulle ou n√©gative, la m√©thode retourne le flux original pour √©viter une division par z√©ro ou des valeurs aberrantes.
- <FontAwesomeIcon icon={faLightbulb} /> Contexte Scientifique :
  - La normalisation par la m√©diane a √©t√© choisie pour sa robustesse aux outliers. Contrairement √† la moyenne, la m√©diane est peu affect√©e par des pixels cosmiques ou des art√©facts tr√®s brillants, ce qui en fait un choix plus s√ªr pour un traitement automatis√© en masse.
</details>

<br/>

### <FontAwesomeIcon icon={faBook} /> Exemples d'Utilisation & Bonnes Pratiques

#### Exemple de base

> Ce snippet montre le workflow nominal pour un seul fichier.

```python title="Exemple d'utilisation compl√®te"
from astropy.io import fits
from src.pipeline.preprocessor import SpectraPreprocessor

# Chemin vers un fichier FITS d'exemple (compress√©)
fits_path = "data/raw/PLAN_NAME/spectrum_file.fits.gz" 

preprocessor = SpectraPreprocessor()

# Utiliser astropy.io.fits pour ouvrir le fichier
# Note : Pour les fichiers .gz, astropy les g√®re automatiquement
with fits.open(fits_path) as hdul:
    
    # 1. Charger le spectre
    wavelength, flux = preprocessor.load_spectrum(hdul)
    
    # 2. Normaliser le flux
    flux_normalized = preprocessor.normalize_spectrum(flux)

print(f"Spectre charg√©. Longueur d'onde de {wavelength.min():.2f} √† {wavelength.max():.2f} √Ö.")
print(f"Flux normalis√© (moyenne) : {flux_normalized.mean():.2f}")
```
<div className="container" style={{padding: '0', marginTop: '2rem'}}>
<div className="row">
<div className="col col--6">
<Admonition type="info" title="Bonnes Pratiques" icon="üí°">
<ul>
<li><strong>Ordre :</strong> Le pr√©traitement est toujours la premi√®re √©tape.</li>
<li><strong>Idempotence :</strong> Ne normalisez pas un spectre d√©j√† normalis√©.</li>
<li><strong>Batch :</strong> Pour traiter de nombreux fichiers, utilisez une boucle avec <code>tqdm</code> pour le suivi.</li>
</ul>
</Admonition>
</div>
<div className="col col--6">
<Admonition type="note" title="Ressources & Code Source" icon="üîó">
<ul>
<li><a href="https://github.com/PhD-Brown/AstroSpectro/blob/main/src/pipeline/preprocessor.py" target="_blank">Code source de <code>preprocessor.py</code></a></li>
<li><a href="https://docs.astropy.org/en/stable/io/fits/" target="_blank">Documentation Astropy FITS</a></li>
<li><a href="http://dr5.lamost.org/" target="_blank">Documentation LAMOST DR5</a></li>
</ul>
</Admonition>
</div>
</div>
</div>
<div className="card">
<div className="card__header" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
<FontAwesomeIcon icon={faArrowRight} />
<h3>Prochaine √âtape du Pipeline</h3>
</div>
<div className="card__body">
<p>Une fois le spectre normalis√©, il est pr√™t pour √™tre transform√© en un vecteur de features num√©riques.</p>
</div>
<div className="card__footer">
<a href="../user-guides/extracting-features" className="button button--primary button--block">
Aller au Guide sur l'Extraction de Features
</a>
</div>
</div>