---
id: preprocessor
title: Explication du pr√©traitement
hide_title: true
sidebar_label: Pr√©traitement
---

<!-- Complet for v1.0.0 release -->

import { FontAwesomeIcon } from '@fortawesome/react-fontawesome'
import { faTools, faFileCode, faObjectGroup, faExclamationTriangle, faLightbulb, faBook, faProjectDiagram, faArrowRight } from '@fortawesome/free-solid-svg-icons'
import Admonition from '@theme/Admonition';

## <FontAwesomeIcon icon={faFileCode} /> `preprocessor.py`

> Ce module contient la classe `SpectraPreprocessor`, responsable du chargement et du nettoyage initial des spectres bruts. C'est la toute premi√®re √©tape de traitement actif du pipeline.

## <FontAwesomeIcon icon={faProjectDiagram} /> Workflow du Pr√©traitement

<div style={{textAlign: 'center', backgroundColor: 'var(--ifm-background-color-secondary)', padding: '1rem', borderRadius: 'var(--ifm-card-border-radius)'}}>

```mermaid
graph TD
    A["Fichier FITS brut (.gz)"] -->|astropy.io.fits| B(HDUList);
    B --> C{load_spectrum};
    C --> D["Spectre (wavelength, flux, invvar)"];
    D --> E(normalize_spectrum);
    E --> F[Spectre Normalis√©<br><i>Pr√™t pour l'extraction de features</i>];
```
</div>

## <FontAwesomeIcon icon={faObjectGroup} /> Classe SpectraPreprocessor

> Encapsule la logique pour lire un fichier FITS de LAMOST DR5 et appliquer un pr√©traitement simple.

### Instanciation

La classe ne prend aucun argument √† l'initialisation.

```python title="Comment l'utiliser"
from src.pipeline.preprocessor import SpectraPreprocessor

# Cr√©e une instance du preprocessor
preprocessor = SpectraPreprocessor()
```

## M√©thodes Publiques :

### ``load_spectrum(hdul)``

> Cette m√©thode est le c≈ìur du chargement des donn√©es. Elle est sp√©cifiquement con√ßue pour le format de donn√©es de LAMOST DR5.

<details>
<summary>Cliquez pour voir les d√©tails de la m√©thode</summary>
- **Description :** Extrait le spectre (longueur d'onde, flux) et l'inverse de la variance √† partir d'un objet `HDUList` ouvert.
- **Arguments :**
- `hdul (astropy.io.fits.HDUList)` : L'objet FITS ouvert.
- **Retourne :**
- `tuple (np.ndarray, np.ndarray, np.ndarray)` : Un tuple contenant trois tableaux NumPy : `(wavelength, flux, invvar)`.
- <FontAwesomeIcon icon={faExclamationTriangle} /> **Erreurs Possibles :**
- `ValueError` : Lev√©e si les mots-cl√©s `COEFF0` ou `COEFF1` sont absents de l'en-t√™te, ou si la structure de donn√©es est invalide.
- <FontAwesomeIcon icon={faLightbulb} /> **Contexte Scientifique :**
- Cette m√©thode est sp√©cifiquement adapt√©e au format des donn√©es LAMOST DR5. Elle extrait le flux de la premi√®re ligne de la matrice de donn√©es, l'inverse de la variance de la deuxi√®me, et reconstruit l'axe des longueurs d'onde en Angstr√∂ms en utilisant les coefficients `COEFF0` et `COEFF1` de l'en-t√™te FITS.
</details>

<br/>

### ``normalize_spectrum(flux)``

> Applique une normalisation simple pour ramener les spectres √† une √©chelle comparable.

<details>
<summary>Cliquez pour voir les d√©tails de la m√©thode</summary>
- **Description :** Normalise un vecteur de flux en le divisant par sa valeur m√©diane.
- **Arguments :**
- `flux (np.ndarray)` : Le vecteur de flux du spectre.
- **Retourne :**
- `np.ndarray` : Le vecteur de flux normalis√©.
- <FontAwesomeIcon icon={faExclamationTriangle} /> **Erreurs Possibles :**
- Aucune. Si la m√©diane est nulle ou n√©gative, la m√©thode retourne le flux original pour √©viter les erreurs de calcul.
- <FontAwesomeIcon icon={faLightbulb} /> **Contexte Scientifique :**
- La normalisation par la m√©diane a √©t√© choisie pour sa robustesse aux *outliers* (comme les rayons cosmiques). Elle permet de ramener le continuum du spectre √† une valeur proche de 1.0, ce qui est essentiel pour comparer la forme des raies spectrales entre diff√©rentes √©toiles.
</details>

<br/>

### <FontAwesomeIcon icon={faBook} /> Exemples d'Utilisation & Bonnes Pratiques

#### Exemple de base

> Ce snippet montre le workflow nominal pour un seul fichier.

```python title="Exemple d'utilisation compl√®te"
from astropy.io import fits
from src.pipeline.preprocessor import SpectraPreprocessor

# Chemin vers un fichier FITS d'exemple (compress√©)
fits_path = "data/raw/PLAN_NAME/spectrum_file.fits.gz" 

preprocessor = SpectraPreprocessor()

# Utiliser astropy.io.fits pour ouvrir le fichier
# Note : Pour les fichiers .gz, astropy les g√®re automatiquement
with fits.open(fits_path) as hdul:
    
    # 1. Charger le spectre
    wavelength, flux = preprocessor.load_spectrum(hdul)
    
    # 2. Normaliser le flux
    flux_normalized = preprocessor.normalize_spectrum(flux)

print(f"Spectre charg√©. Longueur d'onde de {wavelength.min():.2f} √† {wavelength.max():.2f} √Ö.")
print(f"Flux normalis√© (moyenne) : {flux_normalized.mean():.2f}")
```
<br/>
<div className="container" style={{padding: '0', marginTop: '2rem'}}>
<div className="row">
<div className="col col--6">
<Admonition type="info" title="Bonnes Pratiques" icon="üí°">
<ul>
<li><strong>Ordre :</strong> Le pr√©traitement est toujours la premi√®re √©tape active du pipeline.</li>
<li><strong>Robustesse :</strong> Le code est encapsul√© dans des blocs <code>try...except</code> dans le pipeline principal pour g√©rer les fichiers FITS corrompus.</li>
<li><strong>Batch :</strong> Pour traiter de nombreux fichiers, cette classe est appel√©e en boucle par le <code>ProcessingPipeline</code>.</li>
</ul>
</Admonition>
</div>
<div className="col col--6">
<Admonition type="note" title="Ressources & Code Source" icon="üîó">
<ul>
<li><a href="https://github.com/PhD-Brown/AstroSpectro/blob/main/src/pipeline/preprocessor.py" target="_blank">Code source de <code>preprocessor.py</code></a></li>
<li><a href="https://docs.astropy.org/en/stable/io/fits/" target="_blank">Documentation Astropy FITS</a></li>
<li><a href="http://dr5.lamost.org/" target="_blank">Documentation LAMOST DR5</a></li>
</ul>
</Admonition>
</div>
</div>
</div>
<br/>
<div className="card">
<div className="card__header" style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
<FontAwesomeIcon icon={faArrowRight} />
<h3>Prochaine √âtape du Pipeline</h3>
</div>
<div className="card__body">
<p>Une fois le spectre normalis√©, il est pr√™t pour √™tre transform√© en un vecteur de features num√©riques.</p>
</div>
<div className="card__footer">
<a href="../user-guides/extracting-features" className="button button--primary button--block">
Aller au Guide sur l'Extraction de Features
</a>
</div>
</div>